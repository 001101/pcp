#! /bin/sh
# PCP QA Test No. 389
# $Revision: 1.6 $
# pmlogger does not exit with -L when it loses pmcd connection?
# #528442
#
#
# Copyright (c) 1995-2002 Silicon Graphics, Inc.  All Rights Reserved.
#
# creator
owner=kenmcd

seq=`basename $0`
echo "QA output created by $seq"

# get standard filters
. ./common.product
. ./common.filter
. ./common.check

tmp=/tmp/$$
sudo=`pwd`/sudo
host=`hostname`
status=1	# failure is the default!
trap "rm -f $tmp.*; exit \$status" 0 1 2 3 15

# real QA test starts here
echo "=== empty config and _no_ -L, should exit immediately ==="
rm -f $tmp.*
pmlogger -c /dev/null -l $tmp.log $tmp &
sleep 2
echo "expect no pmlogger process ..."
ps $PCP_PS_ALL_FLAGS | $PCP_AWK_PROG '$2 == "'$!'" { print }'
_filter_pmlogger_log <$tmp.log | sed -e "s/$host/HOST/"

echo
echo "=== empty config and -L, should exit when pmcd restarted ==="
rm -f $tmp.*
pmlogger -L -c /dev/null -l $tmp.log $tmp &
_wait_for_pmlogger $! $tmp.log 5
$sudo $PCP_RC_DIR/pcp start | _filter_pcp_start
_wait_for_pmcd
echo "expect no pmlogger process ..."
ps $PCP_PS_ALL_FLAGS | $PCP_AWK_PROG '$2 == "'$!'" { print }'
_filter_pmlogger_log <$tmp.log | sed -e "s/$host/HOST/"

echo
echo "=== non-empty config, should exit when pmcd restarted ==="
rm -f $tmp.*
echo "log mandatory on 1 sec pmcd.version" >$tmp.config
pmlogger -c $tmp.config -l $tmp.log $tmp &
_wait_for_pmlogger $! $tmp.log 5
$sudo $PCP_RC_DIR/pcp start | _filter_pcp_start
_wait_for_pmcd
echo "expect no pmlogger process ..."
ps $PCP_PS_ALL_FLAGS | $PCP_AWK_PROG '$2 == "'$!'" { print }'
_filter_pmlogger_log <$tmp.log | sed -e "s/$host/HOST/"

# success, all done
status=0
exit
