#! /bin/sh
# PCP QA Test No. 260 (formerly 260, 388)
# $Revision: 1.21 $
# test for pmdumptext regressions
#
# bugs #529509 #581372 #581449
#
#
# Copyright (c) 1995-2002 Silicon Graphics, Inc.  All Rights Reserved.
#
# creator
owner=chatz

seq=`basename $0`

if which pmdumptext >/dev/null 2>&1
then
    :
else
    echo "No pmdumptext binary installed" >$seq.notrun
    echo "$seq: [not run] `cat $seq.notrun`"
    exit 0
fi

echo "QA output created by $seq"

# get standard filters
. ./common.filter
. ./common.check

tmp=/tmp/$$
here=`pwd`
sudo=$here/sudo
status=0	# success is the default!
trap "rm -f $tmp.*; exit \$status" 0 1 2 3 15

$sudo rm -f core* $seq.core*

multi=`./getpmcdhosts -p multi -n 1`
single=`./getpmcdhosts -p single -n 1`

_filter()
{
    sed \
    	-e "s/$multi/MULTI/g" \
	-e "s/$single/SINGLE/g" \
	-e 's/[1-2][0-9]*\.000 1\.000/N 1/g' \
	-e 's/[2-9]\.000 1\.000/N 1/g' \
	-e "s/$$/TMP/g"
}

# real QA test starts here

# check support for different hosts at once
eval pmdumptext -lM -s 1 -d "' '" -f "''" $multi:hinv.ncpu $single:hinv.ncpu | _filter

# check that we manage a bad config file OK
pmdumptext -c $tmp.not_here 2>&1 | _filter

# check that instances are converted to canonical units
pmdumptext -C -iu $single:kernel.percpu.cpu.user[cpu0] 2>&1 | _filter

_check_core

exit
