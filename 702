#! /bin/sh
# PCP QA Test No. 702
# $Revision: 1.3 $
#
# Tests out the api (uses torture_api) in archive mode.
# Main motivation is to test the PMNS in arhives for distrib-PMNS.
#
# See 574 for 32 only version.
# Compare 32 and 64 bit versions
#
#
# Copyright (c) 1995-2002 Silicon Graphics, Inc.  All Rights Reserved.
#
# creator
owner=tes

seq=`basename $0`

if [ ! -f src-oss/torture_api.64 ]
then
    echo "No 64-bit version of torture_api app" >$seq.notrun
    echo "$seq: [not run] `cat $seq.notrun`"
    exit 0
fi


echo "QA output created by $seq"

# get standard filters
. ./common.product
. ./common.filter

tmp=/tmp/$$
status=1	# failure is the default!
trap "rm -f $tmp.*; exit \$status" 0 1 2 3 15

rm -rf $seq.full


#
# Create new style version 2 log which includes
# full-path names in the meta-data.
#
_create_logs()
{

# --- Create $tmp.conf ---
    cat << EOF >> $tmp.conf 
#
# pmlogger(1) configuration file 
# used for torture_api
#
log advisory on 1 secs {
EOF
# generate the metric names
    src-oss/torture_api -i -m >> $tmp.conf
    cat << EOF >> $tmp.conf 
}
EOF

    cat $tmp.conf >$seq.full
    echo "" >$seq.full

    pmlogger -c $tmp.conf -V2 -s 1 -l $tmp.pmlog $tmp.logv2
}

#
# Test API on archives using different api-version/log-version/binfmt
#
_do_tests()
{
    testnum=$1
    binfmt=$2

    if [ $binfmt = "64" ]; then
	torture_api="src-oss/torture_api.64"
    else
	torture_api="src-oss/torture_api"
    fi

    $torture_api -i -v -s2 -a $tmp.logv2 2>&1 | _filter_torture_api \
      > $tmp.test$testnum

}

_filter_s_equals()
{
    sed -e 's/<s = [0-9]>//g'
}

_diff()
{
    f1=$1
    f2=$2
    f1filt=$1.filt
    f2filt=$2.filt
    cat $2 | _filter_s_equals > $f2filt
    cat $1 | _filter_s_equals > $f1filt
    empty=0

    if [ ! -s $f1 ]
    then
        f=`echo $f1 | sed -e "s#$tmp#TMP#"` 
	echo "$f is empty"
        empty=1
    fi

    if [ ! -s $f2 ]
    then
        f=`echo $f2 | sed -e "s#$tmp#TMP#"` 
	echo "$f is empty"
        empty=1
    fi

    if [ $empty -ne 1 ]
    then
        diff -s $f1filt $f2filt | sed -e "s#$tmp#TMP#g"
    fi
}


# real QA test starts here
rm -f $tmp.*

_create_logs

# uses libpcp2 and distributed PMNS
_do_tests 1 32
_do_tests 2 64

echo "*** difference 32/64 libpcp2 dist PMNS ***"
_diff $tmp.test1 $tmp.test2


# success, all done
status=0
exit
