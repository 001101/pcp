#! /bin/sh
# PCP QA Test No. 646
# minimal testing for libpcp_mmv functionality
#
# Copyright (c) 1995-2002 Silicon Graphics, Inc.  All Rights Reserved.
#
# creator
owner=makc

seq=`basename $0`

echo "QA output created by $seq"

# get standard environment, filters and checks
. ./common.product
. ./common.filter
. ./common.check

tmp=/tmp/$$
here=`pwd`
sudo=$here/sudo
status=0	# success is the default!
$sudo rm -rf $tmp.*
trap "rm -f $tmp.*; $sudo mv $$tmp.mmv.conf $PCP_PMDAS_DIR/mmv/mmv.conf; $sudo rm -f /var/tmp/mmv/test$$; exit \$status" 0 1 2 3 15

cp $PCP_PMDAS_DIR/mmv/mmv.conf $$tmp.mmv.conf

# Expect failure first time around - test$$ is not in mmv.conf
src-oss/mmv_genstats test$$ | sed -e"s/test$$/TAG/"

# Add magic line to mmv.conf and try again
[ ! -d $PCP_PMDAS_DIR/mmv ] && $sudo mkdir -p $PCP_PMDAS_DIR/mmv
[ ! -d $PCP_TMP_DIR/mmv ] && $sudo mkdir -p $PCP_TMP_DIR/mmv

echo test$$ 999 > $tmp.$seq.conf
$sudo cp $tmp.$seq.conf $PCP_PMDAS_DIR/mmv/mmv.conf
$sudo src-oss/mmv_genstats test$$
src-oss/mmv_dumpstats $PCP_TMP_DIR/mmv/test$$ | \
    sed \
	-e 's/interval = [0-9][0-9]*/interval = TIME/' \
	-e 's/[A-Z][a-z][a-z] [A-Z][a-z][a-z]  *[0-9][0-9]* [0-9][0-9]:[0-9][0-9]:[0-9][0-9] [0-9]*/TIMESTAMP/'

status=0
exit
