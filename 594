#! /bin/sh
# PCP QA Test No. 594
# $Revision: 1.10 $
# pv 779246/782029 test sample.sysinfo vtype / desc
#
#
# Copyright (c) 1995-2002 Silicon Graphics, Inc.  All Rights Reserved.
#
# creator dxm
owner=dxm

seq=`basename $0`

. ./localconfig
if [ $PCP_VER -le 2100 ]
then
    echo "fixes pv#779246, which is only done in pcp 2.2" >$seq.notrun
    echo "$seq: [not run] `cat $seq.notrun`"
    exit 0
fi

echo "QA output created by $seq"

# get standard environment, filters and checks
. ./common.product
. ./common.filter
. ./common.check

tmp=/tmp/$$
here=`pwd`
sudo=$here/sudo
status=1	# failure is the default!
trap "rm -f $tmp.*; exit \$status" 0 1 2 3 15

# we need to replace the bytes output with an indication of how many there were

src-oss/779246 \
    | \
    	sed -e '/pmResult/s/ .* numpmid/ ... numpmid/' \
    |
	$PCP_AWK_PROG '
	/\+\+\+ Expect/ { expsiz = $3; }
	/value \"/ { 
		$2="\"<" length($2)/2-1 " CHARS>\"" 
		$3="[<" length($3)/2-1 " BYTES>]" 
	} 
	/value \[/ { 
		if ( length($2)/2-1 == expsiz ) {
		    $2="[<expected number of BYTES>]" 
		} else {
		    $2=sprintf ("[<%d instead of expected %d BYTES>]",
				length($2)/2-1, expsiz);  
		}
	} 
	{ 
		print
	}'  | sed -e '/+++ Expect/d'

status=0

exit
