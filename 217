#! /bin/sh
# PCP QA Test No. 217
# $Revision: 2.19 $
# check mkaf and pmafm, after file(1) not used
#
# Copyright (c) 1995-2002 Silicon Graphics, Inc.  All Rights Reserved.
#

seq=`basename $0`
echo "QA output created by $seq"

# get standard filters
. ./common.product
. ./common.filter
. ./common.check

tmp=$$"_pmafm"
sudo=`pwd`/sudo
$sudo rm -f $tmp

status=0
trap "rm -f $tmp $tmp.*; exit \$status" 0 1 2 3 15

_filter()
{
    host=`hostname`
    sed \
	-e '/^Created:/{
s/'"$host"'/HOSTNAME/
s/ at .*/ at DATE/
}' \
	-e "s;`pwd`;<initial-path>/qa;" \
	-e '/^Creator:/{
s/mkaf/MKAF_OR_PMCHART/
s/pmchart/MKAF_OR_PMCHART/
}' \
| $PCP_AWK_PROG '
$1 == "Archive:"	{ if ($3 ~ /bar$/ || $3 ~ /bigbin$/ ||
			      $3 ~ /dodgey/ || $3 ~ /foo$/ ||
			      $3 ~ /interp$/ || $3 ~ /truncbin$/)
				$2 = "HOSTNAME"
#               Host                    Basename

			  printf "%-16s%-24s%s\n",$1,$2,$3
			  next
			}
			{ print }'

}

LIST="src-oss/951127.23.01.0 src-oss/960624.08.17.0 src-oss/ace.0 src-oss/bar.0 src-oss/bigace.0 src-oss/bigbin.0 src-oss/bug.0 src-oss/dodgey-all.0 src-oss/dodgey-mixed.0 src-oss/dodgey-some.0 src-oss/foo.0 src-oss/interp.0 src-oss/mirage.0 src-oss/mv-bar.0 src-oss/mv-bigbin.0 src-oss/mv-foo.0 src-oss/mv-interp.0 src-oss/truncbin.0"

HERE=`pwd`
ABSLIST=""
RELLIST=""
for i in $LIST
do
    ABSLIST="$ABSLIST $HERE/$i"
    RELLIST="$RELLIST $i"
done


# real QA test starts here
echo "=== relative names ==="
cd src-oss
echo $LIST | sed -e 's/ /\
/g' | sed -n -e '/src-oss\//s///p' >$tmp.tmp

mkaf `cat $tmp.tmp` >$tmp
_filter <$tmp
rm -f $tmp.tmp

echo
pmafm $tmp check
rm -f $tmp
cd ..

echo
echo "=== absolute pathnames ==="
mkaf $ABSLIST >$tmp
_filter <$tmp
echo
pmafm $tmp check 2>&1 | sed -e "s;`pwd`;<initial-path>/qa;"
rm -f $tmp

echo
echo "=== relative names, down one dir ==="
mkaf $RELLIST >$tmp
_filter <$tmp
echo
pmafm $tmp check
rm -f $tmp

# all done
exit
