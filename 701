#! /bin/sh
# PCP QA Test No. 701
# $Revision: 1.6 $
#
# see also 112 for 32-bit version
#
#
# Copyright (c) 1995-2002 Silicon Graphics, Inc.  All Rights Reserved.
#
# creator
owner=kenmcd

seq=`basename $0`

if [ ! -f src-oss/torture_api.64 ]
then
    echo "No 64-bit version of torture_api app" >$seq.notrun
    echo "$seq: [not run] `cat $seq.notrun`"
    exit 0
fi

echo "QA output created by $seq"

# get standard environment, filters and checks
. ./common.product
. ./common.filter
. ./common.check
. ./localconfig

tmp=/tmp/$$
here=`pwd`
sudo=$here/sudo
status=1
trap "rm -f $tmp.*; exit \$status" 0 1 2 3 15

_filter()
{
    _filter_pmcd_log \
    | _filter_torture_api
}

_cmp()
{
    echo "differences relative to 031.out ..."

    diff $1 031.out.${PCP_PLATFORM}
}

_failok()
{
    sed <$1 \
	-e 's/pcp\[[0-9]*]/pcp[PID]/' \
	-e "s;$tmp;TEMPFILE;g"
}


# real QA test starts here
rm -f $tmp.*
cp $PCP_VAR_DIR/pmns/root $tmp.ascii
if pmnscomp -n $tmp.ascii $tmp.bin >$tmp.out 2>&1
then
    :
else
    cat $tmp.out
    echo "pmnscomp failed!"
    exit
fi


echo "=== pmapi v2, 64-bit app, ascii format pmns ==="
src-oss/torture_api.64 -v -n $tmp.ascii 2>&1 | _filter >$tmp.out
_cmp $tmp.out

echo ""
echo "=== pmapi v2, 64-bit app, binary format pmns ==="
src-oss/torture_api.64 -v -n $tmp.bin 2>&1 | _filter >$tmp.out
_cmp $tmp.out

status=0
exit
