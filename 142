#! /bin/sh
# PCP QA Test No. 142
# $Revision: 2.11 $
#
# memory leaks from pmlogreduce
#
# Copyright (c) 2002 Silicon Graphics, Inc.  All Rights Reserved.

# creator
owner=kenmcd

seq=`basename $0`

if which pmlogreduce >/dev/null 2>&1
then
    :
else
    echo "No pmlogreduce binary installed" >$seq.notrun
    echo "$seq: [not run] `cat $seq.notrun`"
    exit 0
fi

echo "QA output created by $seq"

# get standard environment, filters and checks
. ./common.product
. ./common.filter
. ./common.check

tmp=/tmp/$$
here=`pwd`
sudo=$here/sudo
status=0	# success is the default!
$sudo rm -rf $tmp.*
trap "rm -f $tmp.*; exit \$status" 0 1 2 3 15

# real QA test starts here
pmlogreduce -Dappl2 -S 15s -t 15s src-oss/kenj-pc-1 $tmp >$tmp.out 2>&1

echo "Samples: `pmdumplog $tmp | grep '^[0-2]' | wc -l | sed -e 's/ //g'`"

# echo "memusage: huge (delta 123)" >>$tmp.out

# skip first 5 fetches until things settle down, real interest is in no
# leaks for the next 740 samples
#
echo "Leaks: ..."
grep memusage $tmp.out \
| sed \
    -e 1,5d \
    -e '/delta 0)/d'

cp $tmp.out $seq.full
