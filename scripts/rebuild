#!/bin/sh
#
# Rebuild core libraries and QA apps in a git tree ...
# - run configure the same way Makepkgs does
# - turn off gcc optimization so gdb has a better chance
#   (be aware that this may hide gcc optimizations in the real
#   package builds)
# - make and install libraries over the installed libraries
#   (if any)
# - build enough libraries so "make" in the qa directory works
# - using gdb for apps outside the qa directory should work well
#   once thos apps are rebuilt
#

if [ ! -d .git ]
then
    echo "Error: need to be at the top of the git tree, bozo!"
    exit 1
fi

qa/admin/myconfigure

echo "Disable gcc optimization ..."
sed -i -e '/CFLAGS_OPT/s/-O2/-O0/' src/include/builddefs

# others that could be added to the list below ...
# src/libapp src/libpcp_qed src/libpcp_qwt
#
here=`pwd`
for dir in src/libpcp src/libpcp_pmda src/libpcp_pmcd src/libpcp_gui \
	src/libpcp_web src/libpcp_mmv src/libpcp_import src/libpcp_trace \
	src/libpcp_qmc src/libpcp_fault
do
    echo "=== $dir ==="
    cd $dir
    make clean
    if make
    then
	sudo make install
    else
	echo "Error: make failed!"
	exit 1
    fi
    cd $here
done

echo "=== qa ==="
cd qa
cd src
make clean_exec
cd ..
if make
then
    :
else
    echo "Error: make failed!"
    exit 1
fi

exit 0
