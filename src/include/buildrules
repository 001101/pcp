#
# Copyright (c) 2007 Aconex.  All Rights Reserved.
#
ifndef _BUILDRULES_INCLUDED_
_BUILDRULES_INCLUDED_ = 1

include $(TOPDIR)/src/include/builddefs

clean clobber:
	@rm -f $(DIRT)
	@rm -fr $(DIRDIRT)
	$(SUBDIRS_MAKERULE)

realclean distclean: clean
	rm -f $(TOPDIR)/src/include/builddefs \
	      $(TOPDIR)/src/include/version.h \
	      $(TOPDIR)/src/libqmc/libqmc.pro \
	      $(TOPDIR)/src/libqwt/libqwt.pro \
	      $(TOPDIR)/src/dumptext/pmdumptext.pro \
	      $(TOPDIR)/src/query/pmquery.pro \
	      $(TOPDIR)/src/chart/pmchart.pro \
	      $(TOPDIR)/src/time/pmtime.pro \
	      $(TOPDIR)/man/html/pcpdoc.adp \
	rm -f $(TOPDIR)/pcp-gui.lsm $(TOPDIR)/configure


# Never blow away subdirs
ifdef SUBDIRS
.PRECIOUS: $(SUBDIRS)
endif

src-pcp-gui : $(SRCFILES) $(SUBDIRS)
	@test ! -z "$$SRC_ROOT" || ( echo '$$SRC_ROOT not set ... bozo!' ; echo "... generally unsafe to run make src-pcp-gui outside the Makepkgs script"; exit 1 )
	@test -z "$$DIR" && DIR="."; \
	for f in `echo $^`; do \
	    if test -d $$f ; then \
		$(MAKEF) -j 1 DIR=$$DIR/$$f -C $$f $@ || exit $$?; \
	    else \
		$(ECHO) $$DIR/$$f; \
	    fi; \
	done

src-link-pcp-gui : $(SRCFILES) $(CONFFILES) $(SUBDIRS)
	@test ! -z "$$SRCLINK_ROOT" || ( echo '$$SRCLINK_ROOT not set ... bozo!' ; echo "... generally unsafe to run make src-link-pcp-gui outside the Makepkgs script"; exit 1 )
	@test -z "$$DIR" && DIR="."; \
	for f in `echo $^`; do \
	    if test -d $$f ; then \
		mkdir $$SRCLINK_ROOT/$$DIR/$$f || exit $$?; \
		$(MAKEF) -j 1 DIR=$$DIR/$$f -C $$f $@ || exit $$?; \
	    else \
		ln $$f $$SRCLINK_ROOT/$$DIR/$$f || exit $$?; \
	    fi; \
	done

ifeq ($(PKG_PLATFORM),darwin)
QTMAKE = $(QMAKE) -spec macx-g++ && make -f Makefile
MACBUILD = $(COMMAND).app/Contents
BINARY = $(MACBUILD)/MacOS/$(COMMAND)
LNMAKE = test ! -f $(BINARY) -o -L $(COMMAND) || $(LN_S) $(BINARY) $(COMMAND)
WINDOW = mac
endif
ifeq ($(PKG_PLATFORM),mingw)
QTMAKE = $(QMAKE) && $(MAKE) -f Makefile
BINARY = $(QT_RELEASE)/$(COMMAND)
LNMAKE =
WINDOW = win
endif
ifeq "$(findstring $(PKG_PLATFORM),darwin mingw)" ""
QTMAKE = $(QMAKE) && $(MAKE) -f Makefile
BINARY = $(COMMAND)
LNMAKE =
WINDOW = x11
endif

INSTALL_DIRECTORY_HIERARCHY=\
	d=$(1); while [ "$$d" != "$(2)" -a "$$d" != "/" -a "$$d" != "." ] ; do \
                echo $$d; d=`dirname $$d`; done | sort | while read id; do \
                $(INSTALL) -m 755 -d $$id || exit 1; done;

ifdef ICONLINKS
iconlinks:
	@for l in $(ICONLINKS) ; do \
	    if [ ! -L $$l -a ! -f $$l ] ; then \
		$(LN_S) $(TOPDIR)/images/$$l $$l ; \
	    fi \
	done
endif

ifdef WINDOWLINKS
windowlinks:
	@for l in $(WINDOWLINKS) ; do \
	    if [ ! -L $$l -a ! -f $$l ] ; then \
		$(LN_S) $(WINDOW)_$$l $$l ; \
	    fi \
	done
endif

source :
	$(SOURCE_MAKERULE)

endif # _BUILDRULES_INCLUDED_

$(_FORCE):

.PHONY : depend
