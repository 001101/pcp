#!/bin/sh
# PCP QA Test No. 734
# Exercise bug in pmGetContextHostName with pmcd.hostname metric.
#
# Copyright (c) 2014 Red Hat.
#

seq=`basename $0`
echo "QA output created by $seq"

# get standard environment, filters and checks
. ./common.product
. ./common.filter
. ./common.check

oldhost=`./getpmcdhosts -L -n 1 -v 'pcp<3.8.4'`
[ -z "$oldhost" ] && _notrun "No remote hosts without pmcd.hostname found"
short_oldhost=`echo $oldhost | sed -e 's/\..*//'`

status=1	# failure is the default!
$sudo rm -rf $tmp.* $seq.full
trap "cd $here; rm -rf $tmp.*; exit \$status" 0 1 2 3 15

# real QA test starts here
set -- `pmprobe -h localhost -v pmcd.hostname`
eval newhost=$3
short_newhost=`echo $newhost | sed -e 's/\..*//'`

echo "using oldhost $oldhost ($short_oldhost)" > $seq.full
echo "using newhost $newhost ($short_newhost)" >> $seq.full

pmstat -t 0.2 -s 2 -h localhost -h $oldhost > $tmp.out
grep -q $short_newhost $tmp.out && echo "Correct local hostname in pmstat output"
grep -q $short_oldhost $tmp.out && echo "Correct remote hostname in pmstat output"
cat $tmp.out >> $seq.full

# success, all done
status=0
exit
