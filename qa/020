#!/bin/sh
# PCP GUI QA Test No. 020
# libqmc dynamic indom testing
#
seq=`basename $0`
echo "QA output created by $seq"
. ./common.test

status=0	# success is the default!
rm -f $seq.full

_cleanup()
{
    echo && echo "*** Cleanup ***"
    _dynamic_remove
    rm -f $tmp.*
}

trap "_cleanup; exit \$status" 0 1 2 3 15

# real QA test starts here

_filter2()
{
    sed -n \
	-e '/^\*\*\*/p' \
	-e '/pmGetPDU/p' \
	-e '/pmXmitPDU/p' \
	-e '/^PMC_/p' \
    | sed \
	-e "s/^\[[0-9]*\]//" \
	-e "s/fd=[0-9]/fd=#/" \
	-e "s/from=[0-9]*/from=###/" \
	-e "s/$host/HOST/" \
	-e "s/id = [0-9]*/id = ##########/" \
	-e "s/ptr = 0x0/ptr = NULL/" \
	-e "s/ptr = 0x[0-9a-f]*/ptr = 0x########/" \
    > $tmp.filtered

    echo
    echo "*** PDUs ***"
    sed -n < $tmp.filtered \
	-e '/pmGetPDU/p' \
	-e '/pmXmitPDU/p' \
    | sed \
	-e "s/ fd=.*//" \
    | LC_COLLATE=POSIX sort \
    | uniq -c \
    | sed -e 's/  */ /g'

    echo "*** Transactions ***" > $seq.full
    echo >> $seq.full
    cat $tmp.filtered >> $seq.full
}

_dynamic_install

_check_metric dynamic.numinsts

pmstore dynamic.control.del "-1"

src/qmc_dynamic/qmc_dynamic -DPDU,PMC,INDOM,OPTFETCH 2>$tmp.stderr \
	| sed -e "s/: Line [0-9][0-9]* /: Line <N> /"

cat $tmp.stderr | _filter2

# success, all done
status=0
exit
