#! /bin/sh
#
# make qa_hosts from qa_hosts.master
#
# Copyright (c) 1997-2002 Silicon Graphics, Inc.  All Rights Reserved.
#

# generic initialization
iam=mk.qa_hosts
. ./common.rc

if [ ! -f qa_hosts.master ]
then
    echo "$0: Cannot find \"qa_hosts.master\""
    exit 1
fi

if [ -f qa_hosts -a ! -w qa_hosts ]
then
    echo "$0: Cannot write \"qa_hosts\""
    exit 1
fi

my_host=`hostname | sed -e 's/\..*//'`
my_fqdn=`pmhostname`

# default to Melbourne if no DNS
#
[ -z "$my_fqdn" ] && my_fqdn=$my_host".melbourne.sgi.com"

rm -f qa_hosts
grep "^#order" qa_hosts.master \
| while read tag pat recipe
do
    if echo $my_fqdn | fgrep "$pat" >/dev/null 2>&1
    then
	trap "rm -f /tmp/$$; exit 1" 1 2 3 15

	# strip qa_hosts.master leaving only hosts
	#
	sed -e 's/#.*//' -e '/^ *$/d' qa_hosts.master >/tmp/$$

	# match in turn
	#
	for sel in $recipe
	do
	    fgrep $sel /tmp/$$ \
	    | $PCP_AWK_PROG '
BEGIN	{ srand('$$') }
	{ print 100*rand(),$0 }' \
	    | LC_COLLATE=POSIX _POSIX2_VERSION=0 sort +0n -1 \
	    | cut -d' ' -f2 >>qa_hosts
	done

	rm -f /tmp/$$
	break
    fi
done

if [ ! -f qa_hosts ]
then
    echo "$0: no #order line matches this host \"$my_fqdn\""
    exit 1
fi

exit 0

