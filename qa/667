#! /bin/sh
# PCP QA Test No. 667
# checks basic pcp2graphite functionality
#
# Copyright (c) 2015 Red Hat, Inc.
#
seq=`basename $0`
echo "QA output created by $seq"

. ./common.product
. ./common.filter
. ./common.check

which nc >/dev/null 2>&1 || _notrun "No nc binary installed"
pcp2graphite --version 2>/dev/null || _notrun "python/modules missing"

$sudo rm -rf $tmp.dir
rm -f $seq.full
mkdir $tmp.dir

signal=$PCP_BINADM_DIR/pmsignal
status=1	# failure is the default!

_cleanup()
{
    $sudo rm -rf $tmp.dir
    kill $ncpid $p2gpid 2>/dev/null
}
trap "_cleanup; exit \$status" 0 1 2 3 15

$sudo $PCP_RC_DIR/pmcd start >/dev/null 2>&1

# 
ncpu=`pminfo -f hinv.ncpu | grep value | awk '{print $2.".0"}'`

echo | tee -a $seq.full
echo "=== 1. pcp2graphite one-shot pickle  ===" | tee -a $seq.full
nc -l --recv-only localhost 2004 > $tmp.dir/test1.out &
ncpid=$!
sleep 2
pcp2graphite -t 1 hinv.ncpu hinv.ncpu 2>/dev/null &   # will error out after nc dies
p2gpid=$!
sleep 3
kill $ncpid $p2gpid 2>/dev/null
# python pickled format is not easy to assert correctness
cat $tmp.dir/test1.out |
    egrep -a hinv.ncpu

echo "=== 2. pcp2graphite text, 5-second aligned  ===" | tee -a $seq.full
nc -k -l --recv-only localhost 2003 > $tmp.dir/test2.out &
ncpid=$!
sleep 2
pcp2graphite -t 5 -P 2003 -u '/10' -m foobar. hinv.ncpu 2>/dev/null &
p2gpid=$!
sleep 31 # enough for at least 5 messages
kill $ncpid $p2gpid 2>/dev/null
cat $tmp.dir/test2.out | head -5 |
    sed -r -e 's, [0-9]+\.0 , NCPUS ,' |     # XXX: confirm ncpus value
    sed -r -e 's, [0-9]+[05]$, TIMESTAMP5,'  # confirm time alignment

cat $tmp.dir/test*.out >> $seq.full

status=0
exit
