#! /bin/sh
# PCP QA Test No. 335
# $Revision: 1.1 $
#
# Exercise PM_CONTEXT_LOCAL extensions to pmParesMetricSpec() and libpcp_pmc
#
# Copyright (c) 2008 Ken McDonell.  All Rights Reserved.

# creator
owner=kmcdonell

seq=`basename $0`
echo "QA output created by $seq"

# get standard environment, filters and checks
. ./common.product
. ./common.filter
. ./common.check

tmp=/tmp/$$
here=`pwd`
sudo=$here/sudo
status=0	# success is the default!
$sudo rm -rf $tmp.*
trap "rm -f $tmp.*; exit \$status" 0 1 2 3 15

# real QA test starts here
echo 'expected to fail, $PMDA_LOCAL_SAMPLE unset'
pmdumptext -t 0.5 -s 1 @:sampledso.bin
echo 'expected to pass, $PMDA_LOCAL_SAMPLE set'
export PMDA_LOCAL_SAMPLE=1
pmdumptext -t 0.5 -s 1 @:sampledso.bin | _filter_pmdumptext
pmstore sampledso.write_me 42
echo "expect 2 2 42"
pmdumptext -t 0.5 -s 1 @:sampledso.write_me sampledso.write_me localhost:sampledso.write_me \
| _filter_pmdumptext
echo "expect 42 42 2"
pmdumptext -t 0.5 -s 1 localhost:sampledso.write_me sampledso.write_me @:sampledso.write_me \
| _filter_pmdumptext

pmstore sampledso.write_me 2

# success, all done
exit
