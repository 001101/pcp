#! /bin/sh
# PCP QA Test No. 399
# $Revision: 1.10 $
# pmie core dumps
#
#
# Copyright (c) 1995-2002 Silicon Graphics, Inc.  All Rights Reserved.
#
# creator
owner=kenmcd

seq=`basename $0`
echo "QA output created by $seq"

# get standard filters
. ./common.product
. ./common.check
. ./common.filter

tmp=/tmp/$$
sudo=`pwd`/sudo
status=1	# failure is the default!

# real QA test starts here
./sudo rm -f core

echo
echo "Test 1"
if [ $PCP_PLATFORM = irix ]
then

cat >$tmp.conf <<'End-of-File'
dsk = "irix.disk.dev";
total0 = $delta * $dsk.total@0;
total1 = $delta * $dsk.total@1;
iops = $delta * ($dsk.total@0 - $dsk.total@1);
resp = $delta * 1000 * ($dsk.response@0 - $dsk.response@1);
End-of-File

elif [ $PCP_PLATFORM = linux ]
then

cat >$tmp.conf <<'End-of-File'
dsk = "irix.disk.dev";
total0 = $delta * $dsk.total@0;
total1 = $delta * $dsk.total@1;
iops = $delta * ($dsk.total@0 - $dsk.total@1);
resp = $delta * 1000 * ($dsk.avactive@0 - $dsk.avactive@1);
End-of-File

else
    bozo!
fi

pmie -vv -t 1 -T 1 <$tmp.conf >/dev/null 2>$tmp.err
echo "Stderr output ..."
cat $tmp.err | _show_pmie_errors

if [ -f core ]
then
    echo "Dumped core! (saved as 399.core.1)"
    mv core 399.core.1
fi

echo
echo "Test 2"
if [ $PCP_PLATFORM = irix ]
then

cat >$tmp.conf <<'End-of-File'
dsk = "irix.disk.dev";
total0 = $delta * $dsk.total@0;
total1 = $delta * $dsk.total@1;
iops = $delta * ($dsk.total@0 - $dsk.total@1);
resp = $delta * 1000 * ($dsk.response@0 - $dsk.response@1);
avg = $delta * 1000 * ($dsk.response@0 - $dsk.response@1) / ($dsk.total@0 - $dsk.total@1);
End-of-File

elif [ $PCP_PLATFORM = linux ]
then

cat >$tmp.conf <<'End-of-File'
dsk = "irix.disk.dev";
total0 = $delta * $dsk.total@0;
total1 = $delta * $dsk.total@1;
iops = $delta * ($dsk.total@0 - $dsk.total@1);
resp = $delta * 1000 * ($dsk.avactive@0 - $dsk.avactive@1);
avg = $delta * 1000 * ($dsk.avactive@0 - $dsk.avactive@1) / ($dsk.total@0 - $dsk.total@1);
End-of-File

else
    bozo!
fi

pmie -vv -t 1 -T 1 <$tmp.conf >/dev/null 2>$tmp.err
echo "Stderr output ..."
cat $tmp.err | _show_pmie_errors

if [ -f core ]
then
    echo "Dumped core! (saved as 399.core.2)"
    mv core 399.core.2
fi

# success, all done
status=0
exit
