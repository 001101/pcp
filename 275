#! /bin/sh
# PCP QA Test No. 275 (formerly 275, 395)
# $Revision: 1.27 $
# check that pmdumpmineset handles unavailable metrics OK
#
# Bug #529506
#
#
# Copyright (c) 1995-2002 Silicon Graphics, Inc.  All Rights Reserved.
#
# creator
owner=chatz

seq=`basename $0`
echo "QA output created by $seq"

# get standard filters
. ./common.product
. ./common.filter
. ./common.check

#  Requires common.product:
if [ "$PCP_PLATFORM" = linux ]
then
    echo "No dkprobe in Linux" >$seq.notrun
    echo "$seq: [not run] `cat $seq.notrun`"
    exit 0
fi

tmp=/tmp/$$
sudo=`pwd`/sudo
status=1	# failure is the default!
trap "rm -f $tmp.*; exit \$status" 0 1 2 3 15

_filter()
{
    sed \
    	-e "s/$$/PID/g"
}

# real QA test starts here

cat << end-of-file > $tmp.config
log mandatory on 1 sec {
    hinv.ncpu
    proc.psusage.utime
}
end-of-file

pmlogger -c $tmp.config -l $tmp.log -T 6 $tmp.archive

pmdumpmineset -a $tmp.archive -t 1 $tmp.dump | _filter

echo
echo "Should be nothing after this:"
grep arning $tmp.dump.data $tmp.dump.schema
grep rror $tmp.dump.data $tmp.dump.schema

# success, all done
status=0
exit
