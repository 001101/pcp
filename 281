#! /bin/sh
# PCP QA Test No. 281
# $Revision: 1.10 $
# Exercise pmNewContext() for archives close to the NOFILE max fd limit.
# For incident: 504616
#
#
# Copyright (c) 1995-2002 Silicon Graphics, Inc.  All Rights Reserved.
#
# creator
owner=kenmcd

seq=`basename $0`
echo "QA output created by $seq"

# get standard filters
. ./common.product
. ./common.filter

tmp=/tmp/$$
status=1	# failure is the default!
trap "cd; rm -rf $tmp; exit \$status" 0 1 2 3 15

rm -rf $tmp
mkdir $tmp
cp src-oss/foo.* $tmp
here=`pwd`

# real QA test starts here
cd $tmp

$here/src-oss/arch_maxfd foo \
| tee $seq.full \
| $PCP_AWK_PROG '
$1 == "max"	{ if (maxctx == "") maxctx = $NF
		  $NF = "<max>-" maxctx-$NF
		}
		{ print }'

if [ -f core ]
then
    echo "$here/src-oss/arch_maxfd dumped core!"
    unset TOOLROOT
    echo where | dbx $here/src-oss/arch_maxfd
    exit
fi

# success, all done
status=0
exit
