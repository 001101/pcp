#! /bin/sh
# PCP QA Test No. 628
# $Revision: 1.6 $
# libpcp_pmda botch in pmdaFetch for multiple DSO PMDAs used in the
# on pmFetch ... bug #809111
#
#
# Copyright (c) 1995-2002 Silicon Graphics, Inc.  All Rights Reserved.
#
# creator
owner=kenmcd

seq=`basename $0`

. ./localconfig
if [ $PCP_PLATFORM = linux -a $PCP_VER -ge 2200 ]
then
    : PCP 2.2 or later
elif [ $PCP_PLATFORM = irix -a $PCP_EOE_VER -ge 6512 ]
then
    : IRIX 6.5.12 or later
elif [ $PCP_PLATFORM = irix -a $PCP_EOE_VER -lt 6500 -a $PCP_EOE_VER -ge 2200 ]
then
    : IRIX 6.2 and PCP 2.2
else
    echo "need fix for pv #809111 and multiple DSO PMDAs" >$seq.notrun
    echo "$seq: [not run] `cat $seq.notrun`"
    exit 0
fi

echo "QA output created by $seq"

# get standard environment, filters and checks
. ./common.product
. ./common.filter
. ./common.check

tmp=/tmp/$$
here=`pwd`
sudo=$here/sudo
status=1	# failure is the default!

_cleanup()
{
    cd $here

    [ -f $tmp.root ] && $here/sudo cp $tmp.root $PCP_VAR_DIR/pmns/root
    [ -f $tmp.root.bin ] && $here/sudo cp $tmp.root.bin $PCP_VAR_DIR/pmns/root.bin
    if [ -f $tmp.pmcd.conf ]
    then
	$here/sudo cp $tmp.pmcd.conf $PCP_PMCDCONF_PATH
    fi
    $here/sudo $PCP_RC_DIR/pcp start >/dev/null 2>&1
    $here/sudo rm -rf $tmp.* $PCP_PMDAS_DIR/idiot
    exit $status
}

trap "_cleanup" 0 1 2 3 15

home=$PCP_PMDAS_DIR
if [ ! -d $home/simple ]
then
    echo "Where is $home/simple?"
    exit 1
fi
cd $home/simple
unset ROOT

# restart pmcd and copy the pmcd config file and pmns to restore state later
#
$here/sudo $PCP_RC_DIR/pcp start >/dev/null 2>&1
cp $PCP_PMCDCONF_PATH $tmp.pmcd.conf
cp $PCP_VAR_DIR/pmns/root $tmp.root
cp $PCP_VAR_DIR/pmns/root.bin $tmp.root.bin

if $here/sudo make clobber >$tmp.out 2>&1
then
    :
else
    cat $tmp.out
    echo "Arrgh, make clobber failed"
    exit
fi

$here/sudo rm -rf $PCP_PMDAS_DIR/idiot
$here/sudo mkdir $PCP_PMDAS_DIR/idiot
$here/sudo chmod 777 $PCP_PMDAS_DIR/idiot
cp * $PCP_PMDAS_DIR/idiot

$here/sudo ./Remove >/dev/null 2>&1
cat <<End-of-File | $here/sudo ./Install >$tmp.out 2>&1
both
dso
End-of-File

if pminfo -v simple
then
    :
else
    echo "simple DSO install failed! ... here is the Install log ..."
    cat $tmp.out
fi

cd $PCP_PMDAS_DIR/idiot
mv simple.c idiot.c
mv simple.conf idiot.conf
for file in *
do
    chmod u+w $file
    ed -s $file <<End-of-File
g/simple/s//idiot/g
g/SIMPLE/s//IDIOT/g
g/253/s//177/g
w
q
End-of-File
done

$here/sudo ./Remove >/dev/null 2>&1
cat <<End-of-File | $here/sudo ./Install >$tmp.out 2>&1
both
dso
End-of-File

if pminfo -v idiot
then
    :
else
    echo "idiot DSO install failed! ... here is the Install log ..."
    cat $tmp.out
fi


# real QA test starts here
pminfo -fm simple.numfetch
pminfo -fm idiot.numfetch
pminfo -fm idiot.numfetch
pminfo -fm idiot.numfetch
pminfo -fm simple.numfetch idiot.numfetch

# success, all done
status=0
exit
