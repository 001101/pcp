#! /bin/sh
# PCP QA Test No. 535
# $Revision: 1.10 $
# #535080 - dynamic indoms for pmie, uses sample.dynamic.*
#
#
# Copyright (c) 1995-2002 Silicon Graphics, Inc.  All Rights Reserved.
#
# creator
owner=kenmcd

seq=`basename $0`
echo "QA output created by $seq"

# get standard environment, filters and checks
. ./common.product
. ./common.filter
. ./common.check

tmp=/tmp/$$
sudo=`pwd`/sudo
status=1	# failure is the default!
control=$PCP_PMDAS_DIR/sample/dynamic.indom

_cleanup()
{
    [ -f $control.qa-$seq ] && $sudo mv $control.qa-$seq $control
    rm -f $tmp.*
}

$sudo rm -f $control.qa-$seq

trap "_cleanup; exit \$status" 0 1 2 3 15

[ -f $control ] && $sudo mv $control $control.qa-$seq

# real QA test starts here

$sudo $PCP_RC_DIR/pcp start | _filter_pcp_start
_wait_for_pmcd

# prime the sample PMDA to refresh the dynamic indom
#
pminfo -f sample.dynamic >/dev/null 2>&1

for metric in counter instant discrete
do
    echo
    echo "=== sample.dynamic.$metric ==="

    pmprobe -I sample.dynamic.$metric

    cat <<End-of-File | pmie -t 250msec >$tmp.out 2>&1 &
some_inst ( sample.dynamic.$metric > 0 ) -> shell "echo $metric:" " %i:?";
End-of-File
    pid=$!

    sleep 2

    # initial config
    #
    cat >$tmp.indom <<End-of-File
10 one
20 two
30 three
200 twenty
End-of-File
    $sudo rm -f $control
    $sudo cp $tmp.indom $control
    pmprobe -I sample.dynamic.$metric
    sleep 2

    # add one in the middle
    #
    cat >$tmp.indom <<End-of-File
10 one
20 two
30 three
40 four
200 twenty
End-of-File
    $sudo rm -f $control
    $sudo cp $tmp.indom $control
    pmprobe -I sample.dynamic.$metric
    sleep 2

    # remove all but the first and last
    #
    cat >$tmp.indom <<End-of-File
10 one
200 twenty
End-of-File
    $sudo rm -f $control
    $sudo cp $tmp.indom $control
    pmprobe -I sample.dynamic.$metric
    sleep 2

    # re-instate previous state, with new ones at each end
    #
    cat >$tmp.indom <<End-of-File
00 zero
10 one
20 two
30 three
40 four
200 twenty
210 twenty-one
End-of-File
    $sudo rm -f $control
    $sudo cp $tmp.indom $control
    pmprobe -I sample.dynamic.$metric
    sleep 2

    # replace every second one
    #
    cat >$tmp.indom <<End-of-File
05 zero+
10 one
25 two+
30 three
45 four+
200 twenty
215 twenty-one+
End-of-File
    $sudo rm -f $control
    $sudo cp $tmp.indom $control
    pmprobe -I sample.dynamic.$metric
    sleep 2

    # replace every thing by one (different) instance 
    #
    cat >$tmp.indom <<End-of-File
1 singular
End-of-File
    $sudo rm -f $control
    $sudo cp $tmp.indom $control
    pmprobe -I sample.dynamic.$metric
    sleep 2

    kill -INT $pid
    wait

    $sudo rm -f $control
    pmprobe -I sample.dynamic.$metric

    cp $tmp.out $seq.full

    LC_COLLATE=POSIX sort -u $tmp.out

done

# success, all done
status=0
exit
